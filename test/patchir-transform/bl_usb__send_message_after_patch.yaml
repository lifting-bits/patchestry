# Test patching specification
apiVersion: patchestry.io/v1

metadata:
  name: "usb-security-monitoring-deployment"
  description: "Deploy USB security monitoring for medical device firmware"
  version: "1.0.0"
  author: "Security Team"
  created: "2025-06-31"

target:
  binary: "test_binary.bin"
  arch: "ARM:LE:32:Cortex"

libraries:
 # these references are in relation to the location of this file
  - "patches/usb_security_patches.yaml"

execution_order:
  - "meta_patches::usb_security_meta_patches"
#  - "meta_contracts::usb_security_meta_contracts"

meta_patches:
  - name: usb_security_meta_patches
    description: "Meta patches for USB security"

    # Patch Action Configuration
    patch_actions:
       - id: "USB-PATCH-001"
         description: "Patch to add USB security"

         # Match Configuration
         match:
          - name: "usbd_ep_write_packet"
            kind: "function"
            function_context:
              - name: "bl_usb__send_message"
            argument_matches:
              - index: 0
                name: "usb_g"
                type: "struct struct_anon_struct_4_1_58265f66*"

         # Actions to Apply
         action:
          - mode: "apply_after"
            patch_id: "usb_endpoint_write_validation_after"
            description: "Checks function return value"
            arguments:
              - name: "function_return_value"
                source: "return_value"

#meta_contracts:
#  - name: usb_security_meta_contracts
#    id: "usb_security_meta_contracts"
#    description: "Meta contracts for USB security"

#    contract_actions:
#      - id: "USB-CONTRACT-001"
#        description: "Asserts no error on response"
#
#        match:
#        - name: "usbd_ep_write_packet"
#          kind: "function"
#          function_context:
#            - name: "bl_usb__send_message"
#          argument_matches:
#            - index: 0
#              name: "usb_g"

#        action:
#        - mode: "apply_after"
#          contract_id: "USB-CONTRACT-AFTER-001"
#          arguments:
#            - name: "foo"
#              source: "variable"
#              value: 4
#            - name: "bar"
#              source: "constant"
