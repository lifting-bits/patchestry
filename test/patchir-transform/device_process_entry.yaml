# Test patching specification
apiVersion: patchestry.io/v1

metadata:
  name: "bl-device-process-entry"
  description: "Fix usage of sprintf while processing device entries"
  version: "1.0.0"

target:
  binary: "bloodview"
  arch: "ARM:LE:32"

libraries:
  # these references are in relation to the location of this file
  - "patches/bloodview_device_entry_patches.yaml"

execution_order:
  - "meta_patches::bloodview_device_entry_meta_patch"
  - "meta_contracts::bloodview_device_entry_meta_contract"
  - "meta_contracts::bloodview_device_entry_meta_contract_static"

meta_patches:
  - name: bloodview_device_entry_meta_patch
    id: "bloodview_device_entry_meta_patch"
    description: "Meta patches for fixing get device list in bloodview"

    # Patch Action Configuration
    patch_actions:
      - id: "REPLACE-SPRINTF-001"
        description: "Patch to add USB security"

         # Match Configuration
        match:
          - name: "sprintf"
            kind: "function"
            function_context:
              - name: "bl_device__process_entry"

         # Actions to Apply
        action:
          - mode: "replace"
            patch_id: "DEVICE-LIST-REPLACE-SPRINTF-001"
            description: "Pre-validation security check"
            arguments:
              - name: "argument0"
                source: "operand"
                index: 0
              - name: "argument1"
                source: "constant"
                value: 32
              - name: "argument2"
                source: "operand"
                index: 1
              - name: "argument3"
                source: "operand"
                index: 2

meta_contracts:
  - name: bloodview_device_entry_meta_contract
    id: "bloodview_device_entry_meta_contract"
    description: "Meta contracts for verifying the get device list in bloodview"

    # Contract Configuration
    contract_actions:
      - id: "SPRINTF-CONTRACT-001"

        match:
        - name: "patch__replace__sprintf"
          kind: "function"
          function_context:
            - name: "bl_device__process_entry"

        action:
        - mode: "apply_after"
          contract_id: "DEVICE-LIST-REPLACE-SPRINTF-CONTRACT-001"
          arguments:
            - name: "return_value"
              source: "return_value"
            - name: "dest_size"
              source: "constant"
              value: 32

  - name: bloodview_device_entry_meta_contract_static
    id: "bloodview_device_entry_meta_contract_static"
    description: "Meta contracts for verifying the get device list in bloodview"

    # Contract Configuration
    contract_actions:
      - id: "SPRINTF-CONTRACT-STATIC-001"
        match:
        - name: "patch__replace__sprintf" 
          kind: "function"
          function_context:
            - name: "bl_device__process_entry"

        action:
        - contract_id: "SPRINTF-CONTRACT-STATIC-001"
          mode: "none"
          description: "Static contract to verify the get device list in bloodview"
